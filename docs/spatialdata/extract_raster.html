<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>HydroSimul - Extract values from Raster Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Kan.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">HydroSimul</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../dataset/index.html" rel="" target="">
 <span class="menu-text">Dataset</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../dataprocess/index.html" rel="" target="">
 <span class="menu-text">Dataprocess</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#raster-data" id="toc-raster-data" class="nav-link active" data-scroll-target="#raster-data"><span class="header-section-number">1</span> Raster Data</a></li>
  <li><a href="#extract-from-raster" id="toc-extract-from-raster" class="nav-link" data-scroll-target="#extract-from-raster"><span class="header-section-number">2</span> Extract from Raster</a>
  <ul class="collapse">
  <li><a href="#rough-with-original-resolution" id="toc-rough-with-original-resolution" class="nav-link" data-scroll-target="#rough-with-original-resolution"><span class="header-section-number">2.1</span> Rough with original resolution</a></li>
  <li><a href="#refine-resolution" id="toc-refine-resolution" class="nav-link" data-scroll-target="#refine-resolution"><span class="header-section-number">2.2</span> Refine resolution</a></li>
  <li><a href="#exact-with-area" id="toc-exact-with-area" class="nav-link" data-scroll-target="#exact-with-area"><span class="header-section-number">2.3</span> Exact with Area</a></li>
  <li><a href="#exact-with-scale-product" id="toc-exact-with-scale-product" class="nav-link" data-scroll-target="#exact-with-scale-product"><span class="header-section-number">2.4</span> Exact with scale product</a>
  <ul class="collapse">
  <li><a href="#weight-matrix" id="toc-weight-matrix" class="nav-link" data-scroll-target="#weight-matrix"><span class="header-section-number">2.4.1</span> Weight-Matrix</a></li>
  <li><a href="#value-matrix" id="toc-value-matrix" class="nav-link" data-scroll-target="#value-matrix"><span class="header-section-number">2.4.2</span> Value-Matrix</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Extract values from Raster Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="raster-data" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Raster Data</h1>
<p>Raster Data is actually a kind of Sample data of a area, the area will be divided in regular grids (equally sized rectangles). The typical raster data like elevation is already the most important data for many spatial-based research fields. The raster form is also the important form for meteorological data, in order the area-value (e.g.&nbsp;Temperature and Presentation) to represent. But for the application e.g.&nbsp;in the Hydrology need we some statistical values for specific research regions, especially the Average.</p>
<p>Therefore we need the operate <strong>EXTRACT</strong>.</p>
</section>
<section id="extract-from-raster" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Extract from Raster</h1>
<p>The basic Data are like:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/spatialdata_basic_data.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">The example Data</figcaption>
</figure>
</div>
<ul>
<li>two Raster data</li>
<li>two Regions shape files</li>
</ul>
<p>For the operate <strong>EXTRACT</strong>, we need basically the <strong>raster data</strong> and the <strong>regions (shape files)</strong>. Before this we must confirm that, the both data are in the same CRS (coordinate reference system). In this Blog we discuss only the theories and ideas about <strong>EXTRACT</strong>. There will show total four methods:</p>
<section id="rough-with-original-resolution" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="rough-with-original-resolution"><span class="header-section-number">2.1</span> Rough with original resolution</h2>
<p>The first method we just use the original Raster with <strong>original resolution</strong>. But when the resolution not so fine, it will occur to that the selected grids have the big difference than the region. This is one very typical Problem in meteorological data, they have not so gut space resolution because the time resolution is always finer than the common geological data. In order to balance the data size, we must reduce the space resolution.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/spatialdata_crop_rough.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration of Mask with “Touch” oder “Centerpoint”</figcaption>
</figure>
</div>
<p>For the <strong>SELECT</strong>, there are two familiar methods <code>Touch</code> and <code>Center-point</code>:</p>
<ul>
<li><code>Touch</code>: all the grids, who touched by the region, will be selected</li>
<li><code>Center-point</code>: only the grids, who’s Center-point is with in the region, will be selected</li>
</ul>
<p>For the both <strong>SELECT</strong> methods there some <em>implausible</em> cases:</p>
<ol type="1">
<li><p>when we use <code>Touch</code> method, it will select some grids, who has only a little area within the region, like Cell 4</p></li>
<li><p>Cell 5: only an eighth of the area within the region, but it counts as a “whole cell” just because its center is in the region</p></li>
<li><p>Cell 18: with three quarters of the area in the region, but is not selected, just because the center is <strong>not</strong> in the region</p></li>
</ol>
<p>Summary we can say: the original resolution can be used, only when the deviation between the grids and region is not so big and</p>
<ul>
<li><p><code>Touch</code> includes all grid cells that are touched, so can be used for some extreme statistical value (e.g.&nbsp;Max or Min)</p></li>
<li><p><code>Center-point</code> can be used for the average value and actually the deviation maybe reduced, due to the surplus of selected grids and deficit of not selected grids in the boundary.</p></li>
</ul>
</section>
<section id="refine-resolution" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="refine-resolution"><span class="header-section-number">2.2</span> Refine resolution</h2>
<p>The second method is one simplest method, we need only refine our data in higher resolution, like resolution in 10 times finer and the grids will in 100 times more.</p>
<p>Essentially there is no difference as 1. method, but the problem will be solved. This method is pointed, just because I must use Matlab processing the data, but there is no spatial Analyse Toolbox in Matlab. Therefore this is fast the only Answer, just because the Refine needs no supply from spatial Analyse Toolbox, we can easily repeat the data 10 more in row and 10 more in column.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/spatialdata_crop_disagg.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration of Mask with “Touch” oder “Centerpoint” after Disaggregation</figcaption>
</figure>
</div>
<p>Like the figure shows: the accuracy is gut improvement, the deviation should lay under the 1%.</p>
</section>
<section id="exact-with-area" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="exact-with-area"><span class="header-section-number">2.3</span> Exact with Area</h2>
<p>The weighted mean is always exacter than the numerical average. The important Point for the weighted mean is the weights, in the spatial analyse it’s the portion of the area. So, the main task in third method is calculate the area of every value, that within one region.</p>
<p>In order to calculate the area, we need actually <strong>convert the raster grids into shape</strong>, for the convert we have also two methods:</p>
<ul>
<li>the <strong>same value</strong> as one Polygon (this method should more convenient for the categories data with only several value)</li>
<li>every grid as a rectangle polygon, then calculate the <strong>portion of the area</strong>, where is located within the region (this method is use in <code>R::terra</code> package, but there is also a small deviation, when the CRS lie in lon-lat. The portion of one grid will be not equal to the portion of the region, because the grid area one to one is already different.)</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/spatialdata_crop_exact.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration von Extract mit Wert-Polygon</figcaption>
</figure>
</div>
<p>In the Illustration is every value as the same polygon converted.</p>
</section>
<section id="exact-with-scale-product" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="exact-with-scale-product"><span class="header-section-number">2.4</span> Exact with scale product</h2>
<p>This method is designed only for the meteorological data, those have the <strong>big mange on time scalar</strong>. It’s also the most effective method in the practice.</p>
<p>The theory and the formal is just like:</p>
<p><span class="math display">\[
\vec{\Omega}_{[time,region]} = \vec{A}_{[time,grid]} \cdot \vec{W}_{[grid,region]}
\]</span></p>
<p><span class="math inline">\(\vec{\Omega}_{[time,region]}\)</span> = Region-value of every region</p>
<p><span class="math inline">\(\vec{A}_{[time,grid]}\)</span> = all Value in the matrix [time, grid]</p>
<p><span class="math inline">\(\vec{W}_{[grid,region]}\)</span> = Weights of every grid to every region in the matrix [grid,region]</p>
<section id="weight-matrix" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="weight-matrix"><span class="header-section-number">2.4.1</span> Weight-Matrix</h3>
<p>For the Weight-Matrix calculate we just the portion of the grid area only that within the region to the <strong>whole region area</strong> (but not the whole grid), then divide the area of the region.</p>
<p>One example <code>weight_grid</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>            [R1]      [R2]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> [G1]      <span class="fl">0.000</span>      <span class="fl">0.00</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> [G2] <span class="fl">134364.119</span> <span class="fl">189431.77</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a> [G3] <span class="fl">212464.416</span>      <span class="fl">0.00</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a> [G4]   <span class="fl">2747.413</span>      <span class="fl">0.00</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a> [G5] <span class="fl">150176.618</span>      <span class="fl">0.00</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a> [G6]      <span class="fl">0.000</span>  <span class="fl">45011.22</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>G</code> for Grid and <code>R</code> for Region</p>
</section>
<section id="value-matrix" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="value-matrix"><span class="header-section-number">2.4.2</span> Value-Matrix</h3>
<p>One example <code>mat_value</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>     [G1] [G2] [G3] [G4] [G5] [G6] </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>[T1]    <span class="dv">2</span>    <span class="dv">1</span>    <span class="dv">3</span>    <span class="dv">4</span>    <span class="dv">1</span>    <span class="dv">1</span>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>[T2]    <span class="dv">3</span>    <span class="dv">1</span>    <span class="dv">2</span>    <span class="dv">4</span>    <span class="dv">1</span>    <span class="dv">1</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>T</code> for Time</p>
<p>The end.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>